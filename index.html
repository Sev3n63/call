<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Sistema de Invoice - EUA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .form-section {
            padding: 40px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95em;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Logo Upload Styles */
        .logo-upload-container {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .logo-upload-container:hover {
            border-color: #5a67d8;
            background: #f0f4ff;
            transform: translateY(-2px);
        }

        .logo-upload-container.has-image {
            border-color: #27ae60;
            background: #f8fff8;
        }

        .upload-text {
            color: #667eea;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .upload-icon {
            font-size: 4em;
            color: #667eea;
            margin-bottom: 15px;
        }

        .upload-hint {
            color: #888;
            font-size: 14px;
        }

        #logoInput {
            display: none;
        }

        .logo-preview {
            max-width: 250px;
            max-height: 120px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin: 15px auto;
        }

        .remove-logo {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 14px;
        }

        .remove-logo:hover {
            background: #c0392b;
        }

        .materials-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 25px 0;
        }

        .materials-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .materials-header h3 {
            color: #2c3e50;
            font-size: 1.3em;
        }

        .add-material-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .add-material-btn:hover {
            background: #219a52;
            transform: translateY(-2px);
        }

        .material-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
            margin-bottom: 15px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .remove-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            height: fit-content;
        }

        .remove-btn:hover {
            background: #c0392b;
        }

        .total-section {
            background: #2c3e50;
            color: white;
            padding: 25px;
            text-align: center;
        }

        .total-amount {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .generate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .invoice-preview {
            background: white;
            margin-top: 30px;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: none;
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 40px;
            border-bottom: 2px solid #2c3e50;
            padding-bottom: 20px;
        }

        .company-info {
            flex: 1;
        }

        .invoice-info {
            text-align: right;
        }

        .invoice-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .invoice-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 30px;
        }

        .materials-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .materials-table th,
        .materials-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .materials-table th {
            background: #2c3e50;
            color: white;
        }

        .materials-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .share-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .share-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .share-btn.pdf { background: #e74c3c; }
        .share-btn.whatsapp { background: #25d366; }
        .share-btn.email { background: #f39c12; }
        .share-btn.download { background: #9b59b6; }

        @media print {
            body { background: white; }
            .form-section, .generate-btn { display: none; }
            .invoice-preview { display: block !important; box-shadow: none; }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .form-section {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .material-item {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 15px;
            }

            .header h1 {
                font-size: 2em;
            }

            .total-amount {
                font-size: 2em;
            }

            .generate-btn {
                width: 100%;
                padding: 18px;
            }

            .share-buttons {
                flex-direction: column;
            }

            .share-btn {
                width: 100%;
                justify-content: center;
                padding: 15px;
            }

            .invoice-preview {
                padding: 20px;
                margin-top: 20px;
            }

            .invoice-header {
                flex-direction: column;
                gap: 20px;
                text-align: left;
            }

            .invoice-details {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .materials-table {
                font-size: 14px;
            }

            .materials-table th,
            .materials-table td {
                padding: 8px 4px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .materials-table {
                font-size: 12px;
            }

            .materials-table th,
            .materials-table td {
                padding: 6px 2px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Invoice Generator</h1>
            <p>Sistema profissional de faturas para clientes nos EUA</p>
        </div>

        <div class="form-section">
            <form id="invoiceForm">
                <!-- Logo Upload Section -->
                <div class="form-group full-width">
                    <label>Logo da Empresa:</label>
                    <div class="logo-upload-container" id="logoUploadArea" onclick="document.getElementById('logoInput').click()">
                        <div id="logoContent">
                            <div class="upload-icon">üì∏</div>
                            <div class="upload-text">Clique para adicionar sua logo</div>
                            <div class="upload-hint">PNG, JPG ou JPEG (m√°x. 2MB)</div>
                        </div>
                    </div>
                    <input type="file" id="logoInput" accept="image/*" onchange="handleLogoUpload(this)">
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="companyName">Nome da Empresa:</label>
                        <input type="text" id="companyName" name="companyName" required>
                    </div>

                    <div class="form-group">
                        <label for="serviceProvider">Nome do Prestador de Servi√ßo:</label>
                        <input type="text" id="serviceProvider" name="serviceProvider" required>
                    </div>

                    <div class="form-group">
                        <label for="clientName">Nome do Contratante:</label>
                        <input type="text" id="clientName" name="clientName" required>
                    </div>

                    <div class="form-group">
                        <label for="clientAddress">Endere√ßo do Cliente:</label>
                        <input type="text" id="clientAddress" name="clientAddress" required>
                    </div>

                    <div class="form-group">
                        <label for="invoiceDate">Data da Fatura:</label>
                        <input type="date" id="invoiceDate" name="invoiceDate" required>
                    </div>

                    <div class="form-group">
                        <label for="dueDate">Data de Vencimento:</label>
                        <input type="date" id="dueDate" name="dueDate" required>
                    </div>
                </div>

                <div class="materials-section">
                    <div class="materials-header">
                        <h3>Materiais e Servi√ßos</h3>
                        <button type="button" class="add-material-btn" onclick="addMaterial()">+ Adicionar Item</button>
                    </div>
                    <div id="materialsContainer">
                        <div class="material-item">
                            <div class="form-group">
                                <label>Descri√ß√£o:</label>
                                <input type="text" name="description[]" placeholder="Ex: Consulta t√©cnica" required>
                            </div>
                            <div class="form-group">
                                <label>Quantidade:</label>
                                <input type="number" name="quantity[]" min="1" value="1" onchange="calculateTotal()" required>
                            </div>
                            <div class="form-group">
                                <label>Pre√ßo Unit√°rio ($):</label>
                                <input type="number" name="unitPrice[]" step="0.01" min="0" onchange="calculateTotal()" required>
                            </div>
                            <div class="form-group">
                                <label>Total ($):</label>
                                <input type="number" name="itemTotal[]" step="0.01" readonly>
                            </div>
                            <button type="button" class="remove-btn" onclick="removeMaterial(this)">Remover</button>
                        </div>
                    </div>
                </div>

                <div class="total-section">
                    <div class="total-amount">Total: $<span id="grandTotal">0.00</span></div>
                    <button type="button" class="generate-btn" onclick="generateInvoice()">Gerar Invoice</button>
                </div>
            </form>
        </div>

        <div class="invoice-preview" id="invoicePreview">
            <div class="invoice-header">
                <div class="company-info">
                    <div id="previewLogoContainer" style="margin-bottom: 15px;"></div>
                    <h2 id="previewCompanyName"></h2>
                    <p id="previewServiceProvider"></p>
                </div>
                <div class="invoice-info">
                    <div class="invoice-number">INVOICE #<span id="invoiceNumber"></span></div>
                    <p>Date: <span id="previewInvoiceDate"></span></p>
                    <p>Due Date: <span id="previewDueDate"></span></p>
                </div>
            </div>

            <div class="invoice-details">
                <div>
                    <h3>Bill To:</h3>
                    <p id="previewClientName"></p>
                    <p id="previewClientAddress"></p>
                </div>
                <div>
                    <h3>Service Provider:</h3>
                    <p id="previewServiceProviderDetails"></p>
                </div>
            </div>

            <table class="materials-table">
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="previewMaterialsBody">
                </tbody>
                <tfoot>
                    <tr style="font-weight: bold; background: #2c3e50; color: white;">
                        <td colspan="3">TOTAL AMOUNT</td>
                        <td>$<span id="previewGrandTotal"></span></td>
                    </tr>
                </tfoot>
            </table>

            <div class="share-buttons">
                <button class="share-btn pdf" onclick="generatePDF()">
                    üìÑ Gerar PDF
                </button>
                <button class="share-btn whatsapp" onclick="shareWhatsApp()">
                    üì± WhatsApp
                </button>
                <button class="share-btn email" onclick="shareEmail()">
                    ‚úâÔ∏è Email
                </button>
                <button class="share-btn download" onclick="downloadHTML()">
                    üíæ Download
                </button>
                <button class="share-btn" onclick="window.print()">
                    üñ®Ô∏è Imprimir
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let materialCount = 1;
        let currentInvoiceData = {};
        let companyLogo = null;

        // Simple Logo Upload Function
        function handleLogoUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Check file size (2MB max)
            if (file.size > 2 * 1024 * 1024) {
                alert('Arquivo muito grande! Tamanho m√°ximo: 2MB');
                input.value = '';
                return;
            }

            // Check file type
            if (!file.type.startsWith('image/')) {
                alert('Por favor, selecione apenas imagens (PNG, JPG, JPEG)');
                input.value = '';
                return;
            }

            // Read and display image
            const reader = new FileReader();
            reader.onload = function(e) {
                companyLogo = e.target.result;
                showLogoPreview(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        function showLogoPreview(imageSrc) {
            const logoContent = document.getElementById('logoContent');
            const uploadArea = document.getElementById('logoUploadArea');
            
            logoContent.innerHTML = `
                <img src="${imageSrc}" class="logo-preview" alt="Logo da Empresa">
                <br>
                <button type="button" class="remove-logo" onclick="removeLogo()">Remover Logo</button>
            `;
            
            uploadArea.classList.add('has-image');
        }

        function removeLogo() {
            companyLogo = null;
            document.getElementById('logoInput').value = '';
            const logoContent = document.getElementById('logoContent');
            const uploadArea = document.getElementById('logoUploadArea');
            
            logoContent.innerHTML = `
                <div class="upload-icon">üì∏</div>
                <div class="upload-text">Clique para adicionar sua logo</div>
                <div class="upload-hint">PNG, JPG ou JPEG (m√°x. 2MB)</div>
            `;
            
            uploadArea.classList.remove('has-image');
        }

        function addMaterial() {
            materialCount++;
            const container = document.getElementById('materialsContainer');
            const newMaterial = document.createElement('div');
            newMaterial.className = 'material-item';
            newMaterial.innerHTML = `
                <div class="form-group">
                    <label>Descri√ß√£o:</label>
                    <input type="text" name="description[]" placeholder="Ex: Materiais de constru√ß√£o" required>
                </div>
                <div class="form-group">
                    <label>Quantidade:</label>
                    <input type="number" name="quantity[]" min="1" value="1" onchange="calculateTotal()" required>
                </div>
                <div class="form-group">
                    <label>Pre√ßo Unit√°rio ($):</label>
                    <input type="number" name="unitPrice[]" step="0.01" min="0" onchange="calculateTotal()" required>
                </div>
                <div class="form-group">
                    <label>Total ($):</label>
                    <input type="number" name="itemTotal[]" step="0.01" readonly>
                </div>
                <button type="button" class="remove-btn" onclick="removeMaterial(this)">Remover</button>
            `;
            container.appendChild(newMaterial);
        }

        function removeMaterial(button) {
            if (document.querySelectorAll('.material-item').length > 1) {
                button.parentElement.remove();
                calculateTotal();
            } else {
                alert('Deve haver pelo menos um item na fatura.');
            }
        }

        function calculateTotal() {
            const materials = document.querySelectorAll('.material-item');
            let grandTotal = 0;

            materials.forEach(material => {
                const quantity = parseFloat(material.querySelector('input[name="quantity[]"]').value) || 0;
                const unitPrice = parseFloat(material.querySelector('input[name="unitPrice[]"]').value) || 0;
                const itemTotal = quantity * unitPrice;
                
                material.querySelector('input[name="itemTotal[]"]').value = itemTotal.toFixed(2);
                grandTotal += itemTotal;
            });

            document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
        }

        function generateInvoice() {
            // Generate invoice number
            const invoiceNumber = 'INV-' + Date.now().toString().slice(-6);
            document.getElementById('invoiceNumber').textContent = invoiceNumber;

            // Store invoice data
            currentInvoiceData = {
                invoiceNumber: invoiceNumber,
                companyName: document.getElementById('companyName').value,
                serviceProvider: document.getElementById('serviceProvider').value,
                clientName: document.getElementById('clientName').value,
                clientAddress: document.getElementById('clientAddress').value,
                invoiceDate: document.getElementById('invoiceDate').value,
                dueDate: document.getElementById('dueDate').value,
                grandTotal: document.getElementById('grandTotal').textContent,
                logo: companyLogo
            };

            // Fill preview data
            document.getElementById('previewCompanyName').textContent = currentInvoiceData.companyName;
            document.getElementById('previewServiceProvider').textContent = currentInvoiceData.serviceProvider;
            document.getElementById('previewServiceProviderDetails').textContent = currentInvoiceData.serviceProvider;
            document.getElementById('previewClientName').textContent = currentInvoiceData.clientName;
            document.getElementById('previewClientAddress').textContent = currentInvoiceData.clientAddress;
            document.getElementById('previewInvoiceDate').textContent = currentInvoiceData.invoiceDate;
            document.getElementById('previewDueDate').textContent = currentInvoiceData.dueDate;

            // Display logo in preview
            const logoContainer = document.getElementById('previewLogoContainer');
            if (companyLogo) {
                logoContainer.innerHTML = `<img src="${companyLogo}" alt="Company Logo" style="max-width: 150px; max-height: 80px; object-fit: contain;">`;
            } else {
                logoContainer.innerHTML = '';
            }

            // Fill materials table
            const materialsBody = document.getElementById('previewMaterialsBody');
            materialsBody.innerHTML = '';
            
            currentInvoiceData.materials = [];
            const materials = document.querySelectorAll('.material-item');
            materials.forEach(material => {
                const description = material.querySelector('input[name="description[]"]').value;
                const quantity = material.querySelector('input[name="quantity[]"]').value;
                const unitPrice = parseFloat(material.querySelector('input[name="unitPrice[]"]').value).toFixed(2);
                const itemTotal = parseFloat(material.querySelector('input[name="itemTotal[]"]').value).toFixed(2);

                currentInvoiceData.materials.push({
                    description, quantity, unitPrice, itemTotal
                });

                const row = materialsBody.insertRow();
                row.innerHTML = `
                    <td>${description}</td>
                    <td>${quantity}</td>
                    <td>$${unitPrice}</td>
                    <td>$${itemTotal}</td>
                `;
            });

            document.getElementById('previewGrandTotal').textContent = currentInvoiceData.grandTotal;

            // Show preview
            document.getElementById('invoicePreview').style.display = 'block';
            document.getElementById('invoicePreview').scrollIntoView({ behavior: 'smooth' });
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            let yPos = 20;
            
            // Add logo if available
            if (currentInvoiceData.logo) {
                try {
                    pdf.addImage(currentInvoiceData.logo, 'JPEG', 20, yPos, 50, 25);
                    yPos += 35;
                } catch (e) {
                    console.log('Erro ao adicionar logo ao PDF:', e);
                }
            }
            
            // Add title
            pdf.setFontSize(20);
            pdf.setFont(undefined, 'bold');
            pdf.text('INVOICE', 105, yPos, { align: 'center' });
            yPos += 20;
            
            // Invoice details
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'normal');
            pdf.text(`Invoice #: ${currentInvoiceData.invoiceNumber}`, 20, yPos);
            pdf.text(`Date: ${currentInvoiceData.invoiceDate}`, 20, yPos + 10);
            pdf.text(`Due Date: ${currentInvoiceData.dueDate}`, 20, yPos + 20);
            yPos += 40;
            
            // Company info
            pdf.setFont(undefined, 'bold');
            pdf.text('From:', 20, yPos);
            pdf.setFont(undefined, 'normal');
            pdf.text(currentInvoiceData.companyName, 20, yPos + 10);
            pdf.text(currentInvoiceData.serviceProvider, 20, yPos + 20);
            
            // Client info
            pdf.setFont(undefined, 'bold');
            pdf.text('Bill To:', 120, yPos);
            pdf.setFont(undefined, 'normal');
            pdf.text(currentInvoiceData.clientName, 120, yPos + 10);
            pdf.text(currentInvoiceData.clientAddress, 120, yPos + 20);
            yPos += 50;
            
            // Materials table
            pdf.setFont(undefined, 'bold');
            pdf.text('Description', 20, yPos);
            pdf.text('Qty', 120, yPos);
            pdf.text('Price', 140, yPos);
            pdf.text('Total', 170, yPos);
            
            yPos += 10;
            pdf.line(20, yPos, 190, yPos);
            yPos += 10;
            
            pdf.setFont(undefined, 'normal');
            currentInvoiceData.materials.forEach(item => {
                pdf.text(item.description.substring(0, 25), 20, yPos);
                pdf.text(item.quantity, 120, yPos);
                pdf.text(`$${item.unitPrice}`, 140, yPos);
                pdf.text(`$${item.itemTotal}`, 170, yPos);
                yPos += 10;
            });
            
            // Total
            yPos += 10;
            pdf.line(20, yPos, 190, yPos);
            yPos += 10;
            pdf.setFont(undefined, 'bold');
            pdf.setFontSize(14);
            pdf.text(`TOTAL: $${currentInvoiceData.grandTotal}`, 170, yPos, { align: 'right' });
            
            // Save PDF
            pdf.save(`Invoice_${currentInvoiceData.invoiceNumber}.pdf`);
        }

        function shareWhatsApp() {
            const message = `üßæ *INVOICE* üßæ\n\n` +
                `üìã Invoice #: ${currentInvoiceData.invoiceNumber}\n` +
                `üè¢ Company: ${currentInvoiceData.companyName}\n` +
                `üë§ Client: ${currentInvoiceData.clientName}\n` +
                `üìÖ Date: ${currentInvoiceData.invoiceDate}\n` +
                `üí∞ Total Amount: $${currentInvoiceData.grandTotal}\n\n` +
                `üìÑ Detailed invoice will be sent separately.`;
            
            const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        function shareEmail() {
            const subject = `Invoice ${currentInvoiceData.invoiceNumber} - ${currentInvoiceData.companyName}`;
            const body = `Dear ${currentInvoiceData.clientName},\n\n` +
                `Please find attached the invoice details:\n\n` +
                `Invoice Number: ${currentInvoiceData.invoiceNumber}\n` +
                `Company: ${currentInvoiceData.companyName}\n` +
                `Service Provider: ${currentInvoiceData.serviceProvider}\n` +
                `Invoice Date: ${currentInvoiceData.invoiceDate}\n` +
                `Due Date: ${currentInvoiceData.dueDate}\n` +
                `Total Amount: ${currentInvoiceData.grandTotal}\n\n` +
                `Thank you for your business!\n\n` +
                `Best regards,\n${currentInvoiceData.serviceProvider}`;
            
            const url = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(url);
        }

        function downloadHTML() {
            const logoHTML = currentInvoiceData.logo ? 
                `<div style="margin-bottom: 15px;"><img src="${currentInvoiceData.logo}" alt="Company Logo" style="max-width: 150px; max-height: 80px; object-fit: contain;"></div>` : '';
            
            const invoiceHTML = document.getElementById('invoicePreview').innerHTML;
            const fullHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Invoice ${currentInvoiceData.invoiceNumber}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .invoice-preview { background: white; padding: 20px; }
                        .invoice-header { display: flex; justify-content: space-between; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                        .invoice-details { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px; }
                        .materials-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        .materials-table th, .materials-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        .materials-table th { background: #333; color: white; }
                        .share-buttons { display: none; }
                    </style>
                </head>
                <body>
                    <div class="invoice-preview">
                        ${invoiceHTML.replace('<div id="previewLogoContainer" style="margin-bottom: 15px;"></div>', logoHTML)}
                    </div>
                </body>
                </html>
            `;
            
            const blob = new Blob([fullHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Invoice_${currentInvoiceData.invoiceNumber}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Set default dates
        document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
        const dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + 30);
        document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];

        // Initial calculation
        calculateTotal();
    </script>
</body>
</html>